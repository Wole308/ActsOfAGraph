#ifndef ACTSLW_H
#define ACTSLW_H
#include <string>
#include <string.h>
#include <iostream>
#include <vector>
#include <string.h>
#include <stdio.h>
#include <ctime>
#include <functional>
#include <sys/time.h>
#include <time.h>
#include <stdlib.h>
#include <iomanip>
#include <cmath>
#include <fstream>
#include "../include/actscommon.h"
#include "../../include/common.h"
#ifndef FPGA_IMPL
#include "../../src/utility/utility.h"
#endif
#include "../../acts/actsutility/actsutility.h"
using namespace std;

#define NUMPIPELINES 1
#if NUMPIPELINES==2
#define PP0
#define PP1
#endif 
#if NUMPIPELINES==3
#define PP0
#define PP1
#define PP2
#endif 

#define USEBRAMFORGLOBALSTATS

// #define VECTOR1024_SIZE 16

class actslw {
public:
	actslw();
	~actslw();
	
	unsigned int subandcap(unsigned int val1, unsigned int val2);
	unsigned int lowercapto(unsigned int val, unsigned int capval);
	unsigned int allignhigher_KV(unsigned int val);
	unsigned int allignby2higher_KV(unsigned int val);
	batch_type getskipsize(unsigned int currentLOP, unsigned int sourceORdest);
	void copykeyandvalues(keyvalue_t * buffer1, keyvalue_t * buffer2, unsigned int size);
	void resetkeyandvalues(keyvalue_t * buffer, unsigned int size);
	void resetvalues(keyvalue_t * buffer, unsigned int size);
	void resetkeyandvalues(unsigned int enable, uint512_dt destbuffer[PADDEDDESTBUFFER_SIZE]);
	void resetmanykeyandvalues(keyvalue_t buffer[16][NUM_PARTITIONS], unsigned int size);
	void resetmanykeyandvalues(keyvalue_t buffer[16][PADDEDDESTBUFFER_SIZE], unsigned int size);
	void resetmanyvalues(keyvalue_t buffer[16][NUM_PARTITIONS], unsigned int size);
	void accumkeysandvalues(keyvalue_t * buffer1, keyvalue_t * buffer2, unsigned int size);
	void accumkeysandvalues(keyvalue_t * buffer1, keyvalue_t * buffer2, keyvalue_t * buffer3, unsigned int size);
	unsigned int checkandforce(unsigned int val, unsigned int limit);
	buffer_type getchunksize(buffer_type buffer_size, travstate_t travstate, unsigned int localoffset);
	unsigned int getpartition(keyvalue_t keyvalue, unsigned int currentLOP, vertex_t upperlimit);
	unsigned int getglobalpartition(keyvalue_t keyvalue, vertex_t upperlimit);
	unsigned int reducefunc(keyy_t vid, value_t value, value_t edgeval, unsigned int GraphIter, unsigned int GraphAlgo);
	void copykeyvalues(keyvalue_t * buffer1, keyvalue_t * buffer2, unsigned int size);
	buffer_type getpartitionwritesz(buffer_type realsize_kvs, buffer_type bramoffset_kvs);
	unsigned int withinvalidrange(unsigned int val1, unsigned int val2);
	void calculateoffsets(keyvalue_t * buffer, unsigned int size, unsigned int base, unsigned int skipspacing);
	void calculateoffsets_allignby2(keyvalue_t * buffer, unsigned int size, unsigned int base, unsigned int skipspacing);
	void calculateunallignedoffsets(keyvalue_t buffer[NUM_PARTITIONS], unsigned int size, unsigned int base, unsigned int skipspacing);
	void calculatemanyoffsets(keyvalue_t buffer[16][NUM_PARTITIONS], unsigned int size, unsigned int base, unsigned int skipspacing);
	void calculatemanyunallignedoffsets(keyvalue_t buffer[16][NUM_PARTITIONS], unsigned int size, unsigned int base, unsigned int skipspacing);
	unsigned int get_num_source_partitions(unsigned int currentLOP);
	globalparams_t getglobalparams(uint512_dt * sourcevolume1, uint512_dt * sourcevolume2);
	sweepparams_t getsweepparams(globalparams_t globalparams, unsigned int currentLOP, unsigned int source_partition);
	config_t getconfig(unsigned int currentLOP);
	travstate_t gettravstate(uint512_dt * kvdram1, uint512_dt * kvdram2, keyvalue_t globalstatsbuffer[PADDEDDESTBUFFER_SIZE], globalparams_t globalparams, config_t config, unsigned int currentLOP, unsigned int source_partition, unsigned int num_source_partitions);
	
	{%for inst, inst_ in zip(context['NUMINSTANCES_seq'], context['INSTANCES_charseq'])%}
	void readglobalstats{{inst}}(unsigned int enable, uint512_dt * kvdram1, uint512_dt * kvdram2, keyvalue_t globalstatsbuffer[PADDEDDESTBUFFER_SIZE], keyvalue_t buffer[NUM_PARTITIONS], unsigned int offset_kvs, unsigned int currentLOP, unsigned int sourceORdest);
	{%endfor%}
	
	{%for inst, inst_ in zip(context['NUMINSTANCES_seq'], context['INSTANCES_charseq'])%}
	void saveglobalstats{{inst}}(unsigned int enable, uint512_dt * kvdram1, uint512_dt * kvdram2, keyvalue_t globalstatsbuffer[PADDEDDESTBUFFER_SIZE], keyvalue_t buffer[16][PADDEDDESTBUFFER_SIZE]);
	{%endfor%}
	
	{%for inst, inst_ in zip(context['NUMINSTANCES_seq'], context['INSTANCES_charseq'])%}
	void updateglobalstats{{inst}}(unsigned int enable, uint512_dt * kvdram, keyvalue_t globalstatsbuffer[PADDEDDESTBUFFER_SIZE], keyvalue_t buffer[NUM_PARTITIONS], unsigned int offset_kvs, unsigned int currentLOP, unsigned int sourceORdest);
	{%endfor%}
	
	{%for inst, inst_ in zip(context['NUMINSTANCES_seq'], context['INSTANCES_charseq'])%}
	void prepareglobalstats{{inst}}(unsigned int enable, uint512_dt * kvdram);
	{%endfor%}
	
	{%for inst, inst_ in zip(context['NUMINSTANCES_seq'], context['INSTANCES_charseq'])%}
	void readkeyvalues{{inst}}(unsigned int enable, uint512_dt * kvdram1, uint512_dt * kvdram2, keyvalue_t buffer[16][SRCBUFFER_SIZE], batch_type offset_kvs, travstate_t travstate);
	{%endfor%}
	
	{%for inst, inst_ in zip(context['NUMINSTANCES_seq'], context['INSTANCES_charseq'])%}
	void readvertices{{inst}}(unsigned int enable, uint512_dt * kvdram1, uint512_dt * kvdram2, keyvalue_t buffer[VECTOR_SIZE][PADDEDDESTBUFFER_SIZE], batch_type offset_kvs);
	{%endfor%}
	
	{%for inst, inst_ in zip(context['NUMINSTANCES_seq'], context['INSTANCES_charseq'])%}
	void savekeyvalues{{inst}}(unsigned int enable, uint512_dt * kvdram1, uint512_dt * kvdram2, uint1024_dt buffer[PADDEDDESTBUFFER_SIZE], keyvalue_t * globalcapsule, keyvalue_t localcapsule[NUM_PARTITIONS], batch_type globalbaseaddress_kvs);
	{%endfor%}
	
	{%for inst, inst_ in zip(context['NUMINSTANCES_seq'], context['INSTANCES_charseq'])%}
	void savevertices{{inst}}(unsigned int enable, uint512_dt * kvdram1, uint512_dt * kvdram2, keyvalue_t buffer[VECTOR_SIZE][PADDEDDESTBUFFER_SIZE], batch_type offset_kvs);
	{%endfor%}
	
	{%for inst, inst_ in zip(context['NUMINSTANCES_seq'], context['INSTANCES_charseq'])%}
	void collectglobalstats{{inst}}(unsigned int enable, keyvalue_t sourcebuffer[16][SRCBUFFER_SIZE], keyvalue_t destbuffer[16][PADDEDDESTBUFFER_SIZE], unsigned int upperlimit);
	{%endfor%}
	
	{%for inst, inst_ in zip(context['NUMINSTANCES_seq'], context['INSTANCES_charseq'])%}
	void prepareglobalstats{{inst}}(unsigned int enable, keyvalue_t buffer[VECTOR_SIZE][PADDEDDESTBUFFER_SIZE]);
	{%endfor%}
	
	{%for inst, inst_ in zip(context['NUMINSTANCES_seq'], context['INSTANCES_charseq'])%}
	void partitionkeyvalues{{inst}}(unsigned int enable, keyvalue_t sourcebuffer[16][SRCBUFFER_SIZE], keyvalue_t destbuffer[16][PADDEDDESTBUFFER_SIZE], keyvalue_t localcapsule[16][NUM_PARTITIONS], unsigned int currentLOP, unsigned int upperlimit, travstate_t travstate);
	{%endfor%}
	
	{%for inst, inst_ in zip(context['NUMINSTANCES_seq'], context['INSTANCES_charseq'])%}
	void reduce{{inst}}(unsigned int enable, keyvalue_t sourcebuffer[VECTOR_SIZE][SRCBUFFER_SIZE], keyvalue_t destbuffer[VECTOR_SIZE][PADDEDDESTBUFFER_SIZE], unsigned int upperlimit, unsigned int GraphIter, unsigned int GraphAlgo, travstate_t travstate);
	{%endfor%}
	
	{%for inst, inst_ in zip(context['NUMINSTANCES_seq'], context['INSTANCES_charseq'])%}
	{%for n in context['4_seq']%}
	void combineSetof1stoSetof2{{inst}}_I{{n}}(unsigned int enable, keyvalue_t buffer_setof1M[PADDEDDESTBUFFER_SIZE], keyvalue_t buffer_setof1N[PADDEDDESTBUFFER_SIZE], uint128_dt buffer_setof2[PADDEDDESTBUFFER_SIZE], keyvalue_t localcapsuleM[NUM_PARTITIONS], keyvalue_t localcapsuleN[NUM_PARTITIONS], keyvalue_t localcapsuleR[NUM_PARTITIONS]);
	{%endfor%}
	{%for n in context['2_seq']%}
	void combineSetof2stoSetof4{{inst}}_I{{n}}(unsigned int enable, uint128_dt buffer_setof2M[PADDEDDESTBUFFER_SIZE], uint128_dt buffer_setof2N[PADDEDDESTBUFFER_SIZE], uint256_dt buffer_setof4[PADDEDDESTBUFFER_SIZE], keyvalue_t localcapsuleM[NUM_PARTITIONS], keyvalue_t localcapsuleN[NUM_PARTITIONS], keyvalue_t localcapsuleR[NUM_PARTITIONS]);
	{%endfor%}
	{%for n in context['1_seq']%}
	void combineSetof4stoSetof8{{inst}}_I{{n}}(unsigned int enable, uint256_dt buffer_setof4M[PADDEDDESTBUFFER_SIZE], uint256_dt buffer_setof4N[PADDEDDESTBUFFER_SIZE], uint512_dt buffer_setof8[PADDEDDESTBUFFER_SIZE], keyvalue_t localcapsuleM[NUM_PARTITIONS], keyvalue_t localcapsuleN[NUM_PARTITIONS], keyvalue_t localcapsuleR[NUM_PARTITIONS]);		
	{%endfor%}
	{%endfor%}
	
	{%for inst, inst_ in zip(context['NUMINSTANCES_seq'], context['INSTANCES_charseq'])%}
	{%for n in context['4_seq']%}
	void combineSetof1stoSetof4{{inst}}_I{{n}}(unsigned int enable, keyvalue_t buffer_setof1M[PADDEDDESTBUFFER_SIZE], keyvalue_t buffer_setof1N[PADDEDDESTBUFFER_SIZE], keyvalue_t buffer_setof1O[PADDEDDESTBUFFER_SIZE], keyvalue_t buffer_setof1P[PADDEDDESTBUFFER_SIZE], uint256_dt buffer_setof4[PADDEDDESTBUFFER_SIZE], keyvalue_t localcapsuleM[NUM_PARTITIONS], keyvalue_t localcapsuleN[NUM_PARTITIONS], keyvalue_t localcapsuleO[NUM_PARTITIONS], keyvalue_t localcapsuleP[NUM_PARTITIONS], keyvalue_t localcapsuleR[NUM_PARTITIONS]);
	{%endfor%}
	{%for n in context['1_seq']%}
	void combineSetof4stoSetof16{{inst}}_I{{n}}(unsigned int enable, uint256_dt buffer_setof4M[PADDEDDESTBUFFER_SIZE], uint256_dt buffer_setof4N[PADDEDDESTBUFFER_SIZE], uint256_dt buffer_setof4O[PADDEDDESTBUFFER_SIZE], uint256_dt buffer_setof4P[PADDEDDESTBUFFER_SIZE], uint1024_dt buffer_setof16[PADDEDDESTBUFFER_SIZE], keyvalue_t localcapsule4M[NUM_PARTITIONS], keyvalue_t localcapsule4N[NUM_PARTITIONS], keyvalue_t localcapsule4O[NUM_PARTITIONS], keyvalue_t localcapsule4P[NUM_PARTITIONS], keyvalue_t localcapsuleR[NUM_PARTITIONS]);				
	{%endfor%}
	{%endfor%}
	
	// group functions
	{%for inst, inst_ in zip(context['NUMINSTANCES_seq'], context['INSTANCES_charseq'])%}
	void combineSetof1stoSetof2s{{inst}}(unsigned int enable, keyvalue_t buffer_setof1[8][PADDEDDESTBUFFER_SIZE], uint128_dt buffer_setof2[4][PADDEDDESTBUFFER_SIZE], keyvalue_t templocalcapsule_so1[8][NUM_PARTITIONS], keyvalue_t templocalcapsule_so2[4][NUM_PARTITIONS]);
	void combineSetof2stoSetof4s{{inst}}(unsigned int enable, uint128_dt buffer_setof2[4][PADDEDDESTBUFFER_SIZE], uint256_dt buffer_setof4[2][PADDEDDESTBUFFER_SIZE], keyvalue_t templocalcapsule_so2[4][NUM_PARTITIONS], keyvalue_t templocalcapsule_so4[2][NUM_PARTITIONS]);
	void combineSetof4stoSetof8s{{inst}}(unsigned int enable, uint256_dt buffer_setof4[2][PADDEDDESTBUFFER_SIZE], uint512_dt destbuffer[PADDEDDESTBUFFER_SIZE], keyvalue_t templocalcapsule_so4[2][NUM_PARTITIONS], keyvalue_t templocalcapsule_so8[NUM_PARTITIONS]);
	{%endfor%}
	
	{%for inst, inst_ in zip(context['NUMINSTANCES_seq'], context['INSTANCES_charseq'])%}
	void combineSetof1stoSetof4s{{inst}}(unsigned int enable, keyvalue_t buffer_setof1[16][PADDEDDESTBUFFER_SIZE], uint256_dt buffer_setof4[4][PADDEDDESTBUFFER_SIZE], keyvalue_t templocalcapsule_so1[16][NUM_PARTITIONS], keyvalue_t templocalcapsule_so4[4][NUM_PARTITIONS]);
	void combineSetof4stoSetof16s{{inst}}(unsigned int enable, uint256_dt buffer_setof4[4][PADDEDDESTBUFFER_SIZE], uint1024_dt buffer_setof16[PADDEDDESTBUFFER_SIZE], keyvalue_t templocalcapsule_so4[4][NUM_PARTITIONS], keyvalue_t templocalcapsule_so16[NUM_PARTITIONS]);
	{%endfor%}
	
	{%for inst, inst_ in zip(context['NUMINSTANCES_seq'], context['INSTANCES_charseq'])%}
	void dispatch{{inst}}(uint512_dt * kvdram1, uint512_dt * kvdram2);
	{%endfor%}
	
	void topkernel({%for inst, inst_ in zip(context['NUMINSTANCES_seq'], context['INSTANCES_charseq'])%}{%if(inst>0)%},{%endif%} uint512_dt * source{{inst_}}volume0, uint512_dt * source{{inst_}}volume1 {%endfor%});
	
private:
	#ifndef FPGA_IMPL
	actsutility * actsutilityobj;
	#endif 
};
#endif 







